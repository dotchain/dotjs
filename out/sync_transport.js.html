<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: sync_transport.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: sync_transport.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Copyright (C) 2017 Ramesh Vyaghrapuri. All rights reserved.
// Use of this source code is governed by a MIT-style license
// that can be found in the LICENSE file.

'use strict';

// CreateSyncTransport is a builder for the SyncTransport service
//
// All builders take one parameter which is a map of services. This is
// the dependency injection mechanism.  Builder must return a class.
// Code that runs directly in the builder must not access any fields
// of the builder (so it is not possible to extend builder classes)
// but code within the class (such as the class constructor) can
// safely acess the services.
export function CreateSyncTransport(services) {
    /**
     * SyncTransport implements a basic transport to the
     * [DOT Log service]{@link https://github.com/dotchain/dots}.
     *
     * @see SyncBridge
     *
     * @example &lt;caption>Creating the class &lt;/caption>
     *    // All of dotjs uses a builder pattern where a property
     *    // bag named "services" maintains all the classes
     *    // All classes are created the same way:
     *    import {CreateSyncBridge} from "dotjs/client/sync_transport.js";
     *    services.SyncTransport = CreateSyncTransport(services);
     *
     * @example &lt;caption>Subscribe and initialize a model&lt;/caption>
     *    // to subscribe to: *https://example.com/dot/tasks/123
     *    transport = new services.SyncTransport();
     *    trqnsport.initialize(
     *       "https://example.com/dot/tasks/123",
     *       [],
     *       (bridge) => {
     *            // see SyncBridge on how to use a bridge
     *            // in particular: bridge.model.getValue()
     *       });
     */
    class SyncTransport {
        constructor() {
            this.events = new services.Events();
            this._log = new services.Log("transport: ");

            // url => SyncMuxer
            this._muxers = {};
            // bridge => subID
            this._subs = new Map();
        }

        /** get the latest model at the url and subscribe to it
         * &lt;br>
         * @param url {Url} model url
         * @param clientOps {Operations} any pending local ops
         * @param done {Function} callback with bridge value.
         */
        initialize(url, clientOps, done) {
            const subID = (new services.UUID()).toString();
            const {wsUrl} = services.ModelUrl.parse(url);
            this._muxers[wsUrl] = this._muxers[wsUrl] || new services.SyncMuxer(wsUrl);
            this._muxers[wsUrl].initialize(subID, url, clientOps, bridge => {
                this._subs[bridge] = {subID, wsUrl};
                if (done) done(bridge);
            });
        }

        _attachBridge(bridge) {
            const url = bridge.url;
            const {wsUrl} = services.ModelUrl.parse(url);
            this._muxers[wsUrl] = this._muxers[wsUrl] || new services.SyncMuxer(wsUrl);
            const subID = this._muxers[wsUrl].attach(bridge);
            this._subs[bridge] = {subID, wsUrl};
        }

        _detachBridge(bridge) {
            if (!this._subs[bridge]) return;
            const {subID, wsUrl} = this._subs[bridge];
            delete(this._subs[bridge]);
            this._muxers[wsUrl].detach(subID);
        }
    }
    return SyncTransport;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SyncBridge.html">SyncBridge</a></li><li><a href="SyncTransport.html">SyncTransport</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Dec 29 2017 13:30:24 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
